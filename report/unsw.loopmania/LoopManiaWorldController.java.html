<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoopManiaWorldController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">unsw.loopmania</a> &gt; <span class="el_source">LoopManiaWorldController.java</span></div><h1>LoopManiaWorldController.java</h1><pre class="source lang-java linenums">package unsw.loopmania;

import java.util.ArrayList;
import java.util.List;
import java.util.Random;


import org.codefx.libfx.listener.handle.ListenerHandle;
import org.codefx.libfx.listener.handle.ListenerHandles;

import javafx.animation.Animation;
import javafx.animation.KeyFrame;
import javafx.animation.Timeline;
import javafx.beans.property.SimpleIntegerProperty;
import javafx.beans.value.ChangeListener;
import javafx.beans.value.ObservableValue;
import javafx.event.EventHandler;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.geometry.Point2D;
import javafx.geometry.Pos;
import javafx.geometry.Rectangle2D;
import javafx.scene.Node;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.ClipboardContent;
import javafx.scene.input.DragEvent;
import javafx.scene.input.Dragboard;
import javafx.scene.input.KeyEvent;
import javafx.scene.input.MouseEvent;
import javafx.scene.input.TransferMode;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.paint.Color;
import javafx.util.Duration;
import javafx.scene.control.Label;
import java.util.EnumMap;
import javafx.stage.Stage;
import javafx.scene.text.Font;
import javafx.scene.text.FontWeight;

import java.io.File;
import java.io.IOException;

/**
 * the draggable types.
 * If you add more draggable types, add an enum value here.
 * This is so we can see what type is being dragged.
 */
<span class="nc" id="L51">enum DRAGGABLE_TYPE{</span>
<span class="nc" id="L52">    CARD,</span>
<span class="nc" id="L53">    ITEM</span>
}




/**
 * equiment type
 */ 
<span class="fc" id="L62">enum ITEMS_TYPE{</span>
<span class="fc" id="L63">    SWORD, STAKE, STAFF, ARMOUR, SHIELD, HELMET, THEONERING, HEALTHPOTION</span>
}

/**
 * A JavaFX controller for the world.
 * 
 * All event handlers and the timeline in JavaFX run on the JavaFX application thread:
 *     https://examples.javacodegeeks.com/desktop-java/javafx/javafx-concurrency-example/
 *     Note in https://openjfx.io/javadoc/11/javafx.graphics/javafx/application/Application.html under heading &quot;Threading&quot;, it specifies animation timelines are run in the application thread.
 * This means that the starter code does not need locks (mutexes) for resources shared between the timeline KeyFrame, and all of the  event handlers (including between different event handlers).
 * This will make the game easier for you to implement. However, if you add time-consuming processes to this, the game may lag or become choppy.
 * 
 * If you need to implement time-consuming processes, we recommend:
 *     using Task https://openjfx.io/javadoc/11/javafx.graphics/javafx/concurrent/Task.html by itself or within a Service https://openjfx.io/javadoc/11/javafx.graphics/javafx/concurrent/Service.html
 * 
 *     Tasks ensure that any changes to public properties, change notifications for errors or cancellation, event handlers, and states occur on the JavaFX Application thread,
 *         so is a better alternative to using a basic Java Thread: https://docs.oracle.com/javafx/2/threads/jfxpub-threads.htm
 *     The Service class is used for executing/reusing tasks. You can run tasks without Service, however, if you don't need to reuse it.
 *
 * If you implement time-consuming processes in a Task or thread, you may need to implement locks on resources shared with the application thread (i.e. Timeline KeyFrame and drag Event handlers).
 * You can check whether code is running on the JavaFX application thread by running the helper method printThreadingNotes in this class.
 * 
 * NOTE: http://tutorials.jenkov.com/javafx/concurrency.html and https://www.developer.com/design/multithreading-in-javafx/#:~:text=JavaFX%20has%20a%20unique%20set,in%20the%20JavaFX%20Application%20Thread.
 * 
 * If you need to delay some code but it is not long-running, consider using Platform.runLater https://openjfx.io/javadoc/11/javafx.graphics/javafx/application/Platform.html#runLater(java.lang.Runnable)
 *     This is run on the JavaFX application thread when it has enough time.
 */
public class LoopManiaWorldController {

    /**
     * squares gridpane includes path images, enemies, character, empty grass, buildings
     */
    @FXML
    private GridPane squares;

    /**
     * cards gridpane includes cards and the ground underneath the cards
     */
    @FXML
    private GridPane cards;

    /**
     * anchorPaneRoot is the &quot;background&quot;. It is useful since anchorPaneRoot stretches over the entire game world,
     * so we can detect dragging of cards/items over this and accordingly update DragIcon coordinates
     */
    @FXML
    private AnchorPane anchorPaneRoot;

    /**
     * equippedItems gridpane is for equipped items (e.g. swords, shield, axe)
     */
    @FXML
    private GridPane equippedItems;

    @FXML
    private GridPane unequippedInventory;

    @FXML
    private GridPane characterInfo;
    
    @FXML
    private AnchorPane stats;

    @FXML
    private Label roundsNumLabel;
    // all image views including tiles, character, enemies, cards... even though cards in separate gridpane...
    private List&lt;ImageView&gt; entityImages;

    /**
     * when we drag a card/item, the picture for whatever we're dragging is set here and we actually drag this node
     */
    private DragIcon draggedEntity;

    private boolean isPaused;
    private LoopManiaWorld world;

    /**
     * runs the periodic game logic - second-by-second moving of character through maze, as well as enemies, and running of battles
     */
    private Timeline timeline;

    private Image towerCardImage;
    private Image zombiePitCardImage;
    private Image vampireCastleCardImage;
    private Image barrackCardImage;
    private Image villageCardImage;
    private Image trapCardImage;
    private Image campfireCardImage;
    private Image basicEnemyImage;
    private Image zombieImage;
    private Image vampireImage;
    private Image swordImage;

    private Image towerBuildingImage;
    private Image zombiePitBuildingImage;
    private Image vampireCastleBuildingImage;
    private Image barrackBuildingImage;
    private Image villageBuildingImage;
    private Image trapBuildingImage;
    private Image campfireBuildingImage;
    private Image stakeImage;
    private Image staffImage;
    private Image armourImage;
    private Image shieldImage;
    private Image helmetImage;
    private Image theOneRingImage;
    private Image emptyTheOneRingImage;
    
    private Image heroCastlImage;

    private Image heartImage;
    private Image goldPileslImage;
    /**
     * the image currently being dragged, if there is one, otherwise null.
     * Holding the ImageView being dragged allows us to spawn it again in the drop location if appropriate.
     */
    private ImageView currentlyDraggedImage;
    
    /**
     * null if nothing being dragged, or the type of item being dragged
     */
    private DRAGGABLE_TYPE currentlyDraggedType;

    /**
     * mapping from draggable type enum CARD/TYPE to the event handler triggered when the draggable type is dropped over its appropriate gridpane
     */
    private EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt; gridPaneSetOnDragDropped;
    /**
     * mapping from draggable type enum CARD/TYPE to the event handler triggered when the draggable type is dragged over the background
     */
    private EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt; anchorPaneRootSetOnDragOver;
    /**
     * mapping from draggable type enum CARD/TYPE to the event handler triggered when the draggable type is dropped in the background
     */
    private EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt; anchorPaneRootSetOnDragDropped;
    /**
     * mapping from draggable type enum CARD/TYPE to the event handler triggered when the draggable type is dragged into the boundaries of its appropriate gridpane
     */
    private EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt; gridPaneNodeSetOnDragEntered;
    /**
     * mapping from draggable type enum CARD/TYPE to the event handler triggered when the draggable type is dragged outside of the boundaries of its appropriate gridpane
     */
    private EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt; gridPaneNodeSetOnDragExited;

    /**
     * object handling switching to the main menu
     */
    private MenuSwitcher mainMenuSwitcher;

    private HeroCastleBuilding heroCastleBuilding;


    private CardDescription cardDescription;

    private Stage primaryStage;

    private boolean isSurvivalMode;

    private Label healthPointText;
    private Label goldText;
    private Label expText;
    
    private MainMenuController mainMenuController;

    /**
     * @param world world object loaded from file
     * @param initialEntities the initial JavaFX nodes (ImageViews) which should be loaded into the GUI
     */
<span class="nc" id="L231">    public LoopManiaWorldController(LoopManiaWorld world, List&lt;ImageView&gt; initialEntities) {</span>
<span class="nc" id="L232">        this.world = world;</span>
<span class="nc" id="L233">        entityImages = new ArrayList&lt;&gt;(initialEntities);</span>
<span class="nc" id="L234">        towerCardImage = new Image((new File(&quot;src/images/tower_card.png&quot;)).toURI().toString());</span>
<span class="nc" id="L235">        zombiePitCardImage = new Image((new File(&quot;src/images/zombie_pit_card.png&quot;)).toURI().toString());</span>
<span class="nc" id="L236">        vampireCastleCardImage = new Image((new File(&quot;src/images/vampire_castle_card.png&quot;)).toURI().toString());</span>
<span class="nc" id="L237">        barrackCardImage = new Image((new File(&quot;src/images/barracks_card.png&quot;)).toURI().toString());</span>
<span class="nc" id="L238">        villageCardImage = new Image((new File(&quot;src/images/village_card.png&quot;)).toURI().toString());</span>
<span class="nc" id="L239">        trapCardImage = new Image((new File(&quot;src/images/trap_card.png&quot;)).toURI().toString());</span>
<span class="nc" id="L240">        campfireCardImage = new Image((new File(&quot;src/images/campfire_card.png&quot;)).toURI().toString());</span>
<span class="nc" id="L241">        basicEnemyImage = new Image((new File(&quot;src/images/slug.png&quot;)).toURI().toString());</span>
<span class="nc" id="L242">        zombieImage = new Image((new File(&quot;src/images/zombie.png&quot;)).toURI().toString());</span>
<span class="nc" id="L243">        vampireImage = new Image((new File(&quot;src/images/vampire.png&quot;)).toURI().toString());</span>
<span class="nc" id="L244">        swordImage = new Image((new File(&quot;src/images/basic_sword.png&quot;)).toURI().toString());</span>

<span class="nc" id="L246">        towerBuildingImage = new Image((new File(&quot;src/images/tower.png&quot;)).toURI().toString());</span>
<span class="nc" id="L247">        zombiePitBuildingImage = new Image((new File(&quot;src/images/zombie_pit.png&quot;)).toURI().toString());</span>
<span class="nc" id="L248">        vampireCastleBuildingImage = new Image((new File(&quot;src/images/vampire_castle_building_purple_background.png&quot;)).toURI().toString());</span>
<span class="nc" id="L249">        barrackBuildingImage = new Image((new File(&quot;src/images/barracks.png&quot;)).toURI().toString());</span>
<span class="nc" id="L250">        villageBuildingImage = new Image((new File(&quot;src/images/village.png&quot;)).toURI().toString());</span>
<span class="nc" id="L251">        trapBuildingImage = new Image((new File(&quot;src/images/trap.png&quot;)).toURI().toString());</span>
<span class="nc" id="L252">        campfireBuildingImage = new Image((new File(&quot;src/images/campfire.png&quot;)).toURI().toString());</span>
<span class="nc" id="L253">        heroCastlImage = new Image((new File(&quot;src/images/heros_castle.png&quot;)).toURI().toString());</span>

<span class="nc" id="L255">        stakeImage = new Image((new File(&quot;src/images/stake.png&quot;)).toURI().toString());</span>
<span class="nc" id="L256">        staffImage = new Image((new File(&quot;src/images/staff.png&quot;)).toURI().toString());</span>
<span class="nc" id="L257">        armourImage = new Image((new File(&quot;src/images/armour.png&quot;)).toURI().toString());</span>
<span class="nc" id="L258">        shieldImage = new Image((new File(&quot;src/images/shield.png&quot;)).toURI().toString());</span>
<span class="nc" id="L259">        helmetImage = new Image((new File(&quot;src/images/helmet.png&quot;)).toURI().toString());</span>
<span class="nc" id="L260">        theOneRingImage = new Image((new File(&quot;src/images/the_one_ring.png&quot;)).toURI().toString());</span>
<span class="nc" id="L261">        emptyTheOneRingImage = new Image((new File(&quot;src/images/src_images_the_one_ring.png&quot;)).toURI().toString());</span>
<span class="nc" id="L262">        heartImage= new Image((new File(&quot;src/images/heart.png&quot;)).toURI().toString());</span>
<span class="nc" id="L263">        goldPileslImage = new Image((new File(&quot;src/images/gold_pile.png&quot;)).toURI().toString());</span>
<span class="nc" id="L264">        currentlyDraggedImage = null;</span>
<span class="nc" id="L265">        currentlyDraggedType = null;</span>

        // initialize them all...
<span class="nc" id="L268">        gridPaneSetOnDragDropped = new EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt;(DRAGGABLE_TYPE.class);</span>
<span class="nc" id="L269">        anchorPaneRootSetOnDragOver = new EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt;(DRAGGABLE_TYPE.class);</span>
<span class="nc" id="L270">        anchorPaneRootSetOnDragDropped = new EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt;(DRAGGABLE_TYPE.class);</span>
<span class="nc" id="L271">        gridPaneNodeSetOnDragEntered = new EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt;(DRAGGABLE_TYPE.class);</span>
<span class="nc" id="L272">        gridPaneNodeSetOnDragExited = new EnumMap&lt;DRAGGABLE_TYPE, EventHandler&lt;DragEvent&gt;&gt;(DRAGGABLE_TYPE.class);</span>
<span class="nc" id="L273">    }</span>

    @FXML
    public void initialize() {
        
<span class="nc" id="L278">        Image pathTilesImage = new Image((new File(&quot;src/images/32x32GrassAndDirtPath.png&quot;)).toURI().toString());</span>
<span class="nc" id="L279">        Image inventorySlotImage = new Image((new File(&quot;src/images/empty_slot.png&quot;)).toURI().toString());</span>
<span class="nc" id="L280">        Rectangle2D imagePart = new Rectangle2D(0, 0, 32, 32);</span>

        // Add the ground first so it is below all other entities (inculding all the twists and turns)
<span class="nc bnc" id="L283" title="All 2 branches missed.">        for (int x = 0; x &lt; world.getWidth(); x++) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            for (int y = 0; y &lt; world.getHeight(); y++) {</span>
<span class="nc" id="L285">                ImageView groundView = new ImageView(pathTilesImage);</span>
<span class="nc" id="L286">                groundView.setViewport(imagePart);</span>
<span class="nc" id="L287">                squares.add(groundView, x, y);</span>
            }
        }

        // load entities loaded from the file in the loader into the squares gridpane
<span class="nc bnc" id="L292" title="All 2 branches missed.">        for (ImageView entity : entityImages){</span>
<span class="nc" id="L293">            squares.getChildren().add(entity);</span>
<span class="nc" id="L294">        }</span>

        // add the ground underneath the cards
<span class="nc bnc" id="L297" title="All 2 branches missed.">        for (int x=0; x&lt;world.getWidth(); x++){</span>
<span class="nc" id="L298">            ImageView groundView = new ImageView(pathTilesImage);</span>
<span class="nc" id="L299">            groundView.setViewport(imagePart);</span>
<span class="nc" id="L300">            cards.add(groundView, x, 0);</span>
        }

        // add the empty slot images for the unequipped inventory
<span class="nc bnc" id="L304" title="All 2 branches missed.">        for (int x=0; x&lt;LoopManiaWorld.unequippedInventoryWidth; x++){</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            for (int y=0; y&lt;LoopManiaWorld.unequippedInventoryHeight; y++){</span>
<span class="nc" id="L306">                ImageView emptySlotView = new ImageView(inventorySlotImage);</span>
<span class="nc" id="L307">                unequippedInventory.add(emptySlotView, x, y);</span>
            }
        }

        // create the draggable icon
<span class="nc" id="L312">        draggedEntity = new DragIcon();</span>
<span class="nc" id="L313">        draggedEntity.setVisible(false);</span>
<span class="nc" id="L314">        draggedEntity.setOpacity(0.7);</span>
<span class="nc" id="L315">        anchorPaneRoot.getChildren().add(draggedEntity);</span>

<span class="nc" id="L317">    }</span>

    /**
     * create and run the timer
     */
    public void startTimer(){
<span class="nc" id="L323">        System.out.println(&quot;starting timer&quot;);</span>
<span class="nc" id="L324">        isPaused = false;</span>
        
        // trigger adding code to process main game logic to queue. JavaFX will target framerate of 0.3 seconds
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if(timeline == null){</span>
<span class="nc" id="L328">            timeline = new Timeline(new KeyFrame(Duration.seconds(0.3), event -&gt; {</span>
                // check whether the position is in the Hero's Castle
<span class="nc bnc" id="L330" title="All 2 branches missed.">                if(world.getRoundsNum()== 0){</span>
<span class="nc" id="L331">                    world.addRoundsNum();</span>
                }else{
<span class="nc bnc" id="L333" title="All 2 branches missed.">                    if(heroCastleBuilding.work(world.getCharacter(),this)) return;</span>
                }
<span class="nc" id="L335">                world.runTickMoves();</span>

<span class="nc" id="L337">                Item item = world.getLastUnequippedInventoryItem();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (item != null) {</span>
<span class="nc" id="L339">                    onLoad(item);</span>
                }
<span class="nc" id="L341">                Card card = world.getLastCardEntity();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                if (card != null) {</span>
<span class="nc" id="L343">                    onLoad(card);</span>
                }

<span class="nc bnc" id="L346" title="All 2 branches missed.">                if (world.GetUsedTheOneRing()) {</span>
<span class="nc" id="L347">                    setUsedTheOneRingImage();</span>
                }
<span class="nc bnc" id="L349" title="All 2 branches missed.">                if (world.getIsDead()) {</span>
<span class="nc" id="L350">                    pause();</span>
                }

<span class="nc" id="L353">                List&lt;BasicEnemy&gt; deadEnemies = world.buildingFunction();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                for (BasicEnemy e: deadEnemies){</span>
<span class="nc" id="L355">                    reactToEnemyDefeat(e);</span>
<span class="nc" id="L356">                }</span>

<span class="nc" id="L358">                List&lt;BasicEnemy&gt; defeatedEnemies = world.runBattles();</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                for (BasicEnemy e: defeatedEnemies){</span>
<span class="nc" id="L360">                    reactToEnemyDefeat(e);</span>
<span class="nc" id="L361">                }</span>
<span class="nc" id="L362">                List&lt;BasicEnemy&gt; newEnemies = world.possiblySpawnEnemies();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">                for (BasicEnemy newEnemy: newEnemies){</span>
<span class="nc" id="L364">                    onLoad(newEnemy);</span>
<span class="nc" id="L365">                }</span>
                // update the display
<span class="nc" id="L367">                updateDisplay();</span>
<span class="nc" id="L368">                printThreadingNotes(&quot;HANDLED TIMER&quot;);</span>
<span class="nc" id="L369">            }));</span>
<span class="nc" id="L370">            timeline.setCycleCount(Animation.INDEFINITE);</span>
 
            // build up the hero castle building
<span class="nc" id="L373">            heroCastleBuilding = new HeroCastleBuilding(new SimpleIntegerProperty(0), </span>
             new SimpleIntegerProperty(0), this);
<span class="nc" id="L375">            addHeroCastle(heroCastleBuilding);</span>

            // build up the card descripton
<span class="nc" id="L378">            cardDescription = new CardDescription(this);</span>

<span class="nc" id="L380">            roundsNumLabel.setPadding(new Insets(0,0,0,10));</span>
            // init the display of heath point, gold and exp
<span class="nc" id="L382">            characterInfo.getChildren().clear();</span>
<span class="nc" id="L383">            characterInfo.setPadding(new Insets(10));</span>
<span class="nc" id="L384">            characterInfo.setVgap(10);</span>
<span class="nc" id="L385">            HBox hBox = new HBox();</span>
<span class="nc" id="L386">            hBox.setSpacing(10);</span>
<span class="nc" id="L387">            hBox.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L388">            ImageView imageView = new ImageView();</span>
<span class="nc" id="L389">            imageView.setImage(heartImage);</span>
<span class="nc" id="L390">            healthPointText = new Label();</span>
<span class="nc" id="L391">            healthPointText.setFont(Font.font(&quot;Microsoft YaHei&quot;,FontWeight.BOLD,16));</span>
<span class="nc" id="L392">            healthPointText.setTextFill(new Color(0.9,0,0,1));</span>
<span class="nc" id="L393">            hBox.getChildren().addAll(imageView,healthPointText);</span>
<span class="nc" id="L394">            characterInfo.add(hBox, 0,0);</span>
<span class="nc" id="L395">            hBox = new HBox();</span>
<span class="nc" id="L396">            hBox.setSpacing(10);</span>
<span class="nc" id="L397">            hBox.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L398">            imageView = new ImageView();</span>
<span class="nc" id="L399">            imageView.setImage(goldPileslImage);</span>
<span class="nc" id="L400">            goldText = new Label();</span>
<span class="nc" id="L401">            goldText.setFont(Font.font(&quot;Microsoft YaHei&quot;,FontWeight.BOLD,16));</span>
<span class="nc" id="L402">            goldText.setTextFill(new Color(0,0.9,0,1));</span>
<span class="nc" id="L403">            hBox.getChildren().addAll(imageView,goldText);</span>
<span class="nc" id="L404">            characterInfo.add(hBox, 0,1);</span>
<span class="nc" id="L405">            hBox = new HBox();</span>
<span class="nc" id="L406">            hBox.setSpacing(10);</span>
<span class="nc" id="L407">            hBox.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L408">            Label label = new Label(&quot;EXP&quot;);</span>
<span class="nc" id="L409">            label.setFont(Font.font(&quot;Microsoft YaHei&quot;,FontWeight.BOLD,16));</span>
<span class="nc" id="L410">            label.setTextFill(new Color(0.64,0.28,0.64,1));</span>
<span class="nc" id="L411">            expText = new Label();</span>
<span class="nc" id="L412">            expText.setFont(Font.font(&quot;Microsoft YaHei&quot;,FontWeight.BOLD,16));</span>
<span class="nc" id="L413">            expText.setTextFill(new Color(0.64,0.28,0.64,1));</span>
<span class="nc" id="L414">            hBox.getChildren().addAll(label,expText);</span>
<span class="nc" id="L415">            characterInfo.add(hBox, 0,2);</span>
        }
<span class="nc" id="L417">        timeline.play();</span>
<span class="nc" id="L418">    }</span>

    public void updateDisplay(){
        // update the dispaly of number of the round
<span class="nc" id="L422">        roundsNumLabel.setText(String.format(&quot;ROUND %d&quot;, world.getRoundsNum()));</span>
<span class="nc" id="L423">        healthPointText.setText(String.format(&quot;%d/100&quot;, world.getCharacter().getHealth()));</span>
<span class="nc" id="L424">        goldText.setText(String.format(&quot;%d&quot;, world.getCharacter().getGold()));</span>
<span class="nc" id="L425">        expText.setText(String.format(&quot;%d&quot;, world.getCharacter().getEXP()));</span>
<span class="nc" id="L426">    }</span>

    /**
     * pause the execution of the game loop
     * the human player can still drag and drop items during the game pause
     */
    public void pause(){
<span class="nc" id="L433">        isPaused = true;</span>
<span class="nc" id="L434">        System.out.println(&quot;pausing&quot;);</span>
<span class="nc" id="L435">        timeline.stop();</span>
<span class="nc" id="L436">    }</span>

    /**
     *  terminate pause
     */
    public void terminate(){
<span class="nc" id="L442">        pause();</span>
<span class="nc" id="L443">    }</span>

    /**
     * pair the entity an view so that the view copies the movements of the entity.
     * add view to list of entity images
     * @param entity backend entity to be paired with view
     * @param view frontend imageview to be paired with backend entity
     */
    private void addEntity(Entity entity, ImageView view) {
<span class="nc" id="L452">        trackPosition(entity, view);</span>
<span class="nc" id="L453">        entityImages.add(view);</span>
<span class="nc" id="L454">    }</span>
    
    /**
     * load a card from the world by name, and pair it with an image in the GUI
     */
    private void loadCardByType(CARDS_TYPE cards_TYPE) {
        // DONE = load more types of card
<span class="nc" id="L461">        Card card = world.loadCard(cards_TYPE);</span>
<span class="nc" id="L462">        onLoad(card);</span>
<span class="nc" id="L463">    }</span>

    /**
     * load a item from the world, and pair it with an image in the GUI
     */
    public void loadItemByType(ITEMS_TYPE itemType) {
        // start by getting first available coordinates
<span class="nc" id="L470">        Item item = world.addUnequippedItem(itemType);</span>
<span class="nc" id="L471">        onLoad(item);</span>
<span class="nc" id="L472">    }</span>


    /**
     * run GUI events after an enemy is defeated, such as spawning items/experience/gold
     * @param enemy defeated enemy for which we should react to the death of
     */
    private void reactToEnemyDefeat(BasicEnemy enemy){
        // react to character defeating an enemy
        // in starter code, spawning extra card/weapon...
        // provide different benefits to defeating the enemy based on the type of enemy

        // a type of card is looted from the enemies with a specified probability
<span class="nc" id="L485">        int index = new Random().nextInt(100);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if(index &lt; 42){</span>
<span class="nc" id="L487">            index = index / 6;</span>
<span class="nc" id="L488">            loadCardByType(CARDS_TYPE.values()[index]);</span>
        }

<span class="nc" id="L491">        int rd = new Random().nextInt(100);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (rd &lt; 20) {</span>
<span class="nc" id="L493">            loadItemByType(ITEMS_TYPE.SWORD);    </span>
<span class="nc bnc" id="L494" title="All 4 branches missed.">        } else if (rd &gt;= 20 &amp;&amp; rd &lt; 35) {</span>
<span class="nc" id="L495">            loadItemByType(ITEMS_TYPE.STAKE);  </span>
<span class="nc bnc" id="L496" title="All 4 branches missed.">        } else if (rd &gt;= 35 &amp;&amp; rd &lt; 45) {</span>
<span class="nc" id="L497">            loadItemByType(ITEMS_TYPE.STAFF);  </span>
<span class="nc bnc" id="L498" title="All 4 branches missed.">        } else if (rd &gt;= 45 &amp;&amp; rd &lt; 55) {</span>
<span class="nc" id="L499">            loadItemByType(ITEMS_TYPE.ARMOUR);  </span>
<span class="nc bnc" id="L500" title="All 4 branches missed.">        } else if (rd &gt;= 55 &amp;&amp; rd &lt; 70) {</span>
<span class="nc" id="L501">            loadItemByType(ITEMS_TYPE.SHIELD);  </span>
<span class="nc bnc" id="L502" title="All 4 branches missed.">        } else if (rd &gt;= 70 &amp;&amp; rd &lt; 85) {</span>
<span class="nc" id="L503">            loadItemByType(ITEMS_TYPE.HELMET);  </span>
<span class="nc bnc" id="L504" title="All 4 branches missed.">        } else if (rd &gt;= 85 &amp;&amp; rd &lt; 90) {</span>
<span class="nc" id="L505">            loadItemByType(ITEMS_TYPE.THEONERING);  </span>
<span class="nc bnc" id="L506" title="All 4 branches missed.">        } else if (rd &gt;= 90 &amp;&amp; rd &lt;= 100) {</span>
<span class="nc" id="L507">            world.getCharacter().setHealth(world.getCharacter().getHealth() + 50); // health potion</span>
        }
<span class="nc" id="L509">        world.getCharacter().setGold(world.getCharacter().getGold() + enemy.getGoldDefeated());</span>
<span class="nc" id="L510">        world.getCharacter().setEXP(world.getCharacter().getEXP() + enemy.getEXP());</span>
<span class="nc" id="L511">    }</span>

    /**
     * load a card into the GUI.
     * Particularly, we must connect to the drag detection event handler,
     * and load the image into the cards GridPane.
     * @param vampireCastleCard
     */
    private void onLoad(Card card) {
<span class="nc" id="L520">        ImageView view = null;</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if(card instanceof TowerCard){</span>
<span class="nc" id="L522">            view = new ImageView(towerCardImage);</span>
        }
<span class="nc bnc" id="L524" title="All 2 branches missed.">        else if(card instanceof ZombiePitCard){</span>
<span class="nc" id="L525">            view = new ImageView(zombiePitCardImage);</span>
        }
<span class="nc bnc" id="L527" title="All 2 branches missed.">        else if(card instanceof VampireCastleCard){</span>
<span class="nc" id="L528">            view = new ImageView(vampireCastleCardImage);</span>
        }
<span class="nc bnc" id="L530" title="All 2 branches missed.">        else if(card instanceof BarrackCard){</span>
<span class="nc" id="L531">            view = new ImageView(barrackCardImage);</span>
        }
<span class="nc bnc" id="L533" title="All 2 branches missed.">        else if(card instanceof VillageCard){</span>
<span class="nc" id="L534">            view = new ImageView(villageCardImage);</span>
        }
<span class="nc bnc" id="L536" title="All 2 branches missed.">        else if(card instanceof TrapCard){</span>
<span class="nc" id="L537">            view = new ImageView(trapCardImage);</span>
        }
<span class="nc bnc" id="L539" title="All 2 branches missed.">        else if(card instanceof CampfireCard){</span>
<span class="nc" id="L540">            view = new ImageView(campfireCardImage);</span>
        }

        // FROM https://stackoverflow.com/questions/41088095/javafx-drag-and-drop-to-gridpane
        // note target setOnDragOver and setOnDragEntered defined in initialize method
<span class="nc" id="L545">        addDragEventHandlers(view, DRAGGABLE_TYPE.CARD, cards, squares);</span>

<span class="nc" id="L547">        addEntity(card, view);</span>
<span class="nc" id="L548">        cards.getChildren().add(view);</span>
<span class="nc" id="L549">        view.setOnMouseEntered(new CardMouseHoverHandler(card.getName(),card.getDescription()));</span>
<span class="nc" id="L550">        view.setOnMouseExited(new CardMouseLeaveHandler());</span>
<span class="nc" id="L551">    }</span>

    /**
     * load a item into the GUI.
     * Particularly, we must connect to the drag detection event handler,
     * and load the image into the unequippedInventory GridPane.
     * @param item
     */
    private void onLoad(Item item) {
<span class="nc" id="L560">        ImageView view = null;</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">        if (item instanceof Sword) {</span>
<span class="nc" id="L562">            view = new ImageView(swordImage);</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">        } else if (item instanceof Stake) {</span>
<span class="nc" id="L564">            view = new ImageView(stakeImage);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">        } else if (item instanceof Staff) {</span>
<span class="nc" id="L566">            view = new ImageView(staffImage);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">        } else if (item instanceof Armour) {</span>
<span class="nc" id="L568">            view = new ImageView(armourImage);</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">        } else if (item instanceof Shield) {</span>
<span class="nc" id="L570">            view = new ImageView(shieldImage);</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        } else if (item instanceof Helmet) {</span>
<span class="nc" id="L572">            view = new ImageView(helmetImage);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        } else if (item instanceof TheOneRing) {</span>
<span class="nc" id="L574">            view = new ImageView(theOneRingImage);</span>
        }

<span class="nc" id="L577">        addDragEventHandlers(view, DRAGGABLE_TYPE.ITEM, unequippedInventory, equippedItems);</span>
<span class="nc" id="L578">        addEntity(item, view);</span>
<span class="nc" id="L579">        unequippedInventory.getChildren().add(view);</span>
<span class="nc" id="L580">    }</span>

    /**
     * load an enemy into the GUI
     * @param enemy
     */
    public void onLoad(BasicEnemy enemy) {
<span class="nc" id="L587">        ImageView view = null;</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if(enemy instanceof Zombie){</span>
<span class="nc" id="L589">            view = new ImageView(zombieImage);</span>
        }
<span class="nc bnc" id="L591" title="All 2 branches missed.">        else if(enemy instanceof Vampire){</span>
<span class="nc" id="L592">            view = new ImageView(vampireImage);</span>
        }
<span class="nc bnc" id="L594" title="All 2 branches missed.">        else if(enemy instanceof BasicEnemy){</span>
<span class="nc" id="L595">            view = new ImageView(basicEnemyImage);</span>
        }
<span class="nc" id="L597">        addEntity(enemy, view);</span>
<span class="nc" id="L598">        squares.getChildren().add(view);</span>
<span class="nc" id="L599">    }</span>

    /**
     * load a hero castle into the GUI
     */
    public void addHeroCastle(Entity heroEntity) {
<span class="nc" id="L605">        ImageView view = new ImageView(heroCastlImage);</span>
<span class="nc" id="L606">        addEntity(heroEntity, view);</span>
<span class="nc" id="L607">        squares.getChildren().add(view);</span>
<span class="nc" id="L608">    }</span>

    /**
     * load a building into the GUI
     * @param building
     */
    private void onLoad(Building building){
<span class="nc" id="L615">        ImageView view = null;</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">        if(building instanceof TowerBuilding){</span>
<span class="nc" id="L617">            view = new ImageView(towerBuildingImage);</span>
        }
<span class="nc bnc" id="L619" title="All 2 branches missed.">        else if(building instanceof ZombiePitBuilding){</span>
<span class="nc" id="L620">            view = new ImageView(zombiePitBuildingImage);</span>
        }
<span class="nc bnc" id="L622" title="All 2 branches missed.">        else if(building instanceof VampireCastleBuilding){</span>
<span class="nc" id="L623">            view = new ImageView(vampireCastleBuildingImage);</span>
        }
<span class="nc bnc" id="L625" title="All 2 branches missed.">        else if(building instanceof BarrackBuilding){</span>
<span class="nc" id="L626">            view = new ImageView(barrackBuildingImage);</span>
        }
<span class="nc bnc" id="L628" title="All 2 branches missed.">        else if(building instanceof VillageBuilding){</span>
<span class="nc" id="L629">            view = new ImageView(villageBuildingImage);</span>
        }
<span class="nc bnc" id="L631" title="All 2 branches missed.">        else if(building instanceof TrapBuilding){</span>
<span class="nc" id="L632">            view = new ImageView(trapBuildingImage);</span>
        }
<span class="nc bnc" id="L634" title="All 2 branches missed.">        else if(building instanceof CampfireBuilding){</span>
<span class="nc" id="L635">            view = new ImageView(campfireBuildingImage);</span>
        }
<span class="nc" id="L637">        addEntity(building, view);</span>
<span class="nc" id="L638">        squares.getChildren().add(view);</span>
<span class="nc" id="L639">    }</span>

    /**
     * add drag event handlers for dropping into gridpanes, dragging over the background, dropping over the background.
     * These are not attached to invidual items such as swords/cards.
     * @param draggableType the type being dragged - card or item
     * @param sourceGridPane the gridpane being dragged from
     * @param targetGridPane the gridpane the human player should be dragging to (but we of course cannot guarantee they will do so)
     */
    private void buildNonEntityDragHandlers(DRAGGABLE_TYPE draggableType, GridPane sourceGridPane, GridPane targetGridPane){
        // TODO = be more selective about where something can be dropped
        // for example, in the specification, villages can only be dropped on path, whilst vampire castles cannot go on the path

<span class="nc" id="L652">        gridPaneSetOnDragDropped.put(draggableType, new EventHandler&lt;DragEvent&gt;() {</span>
            public void handle(DragEvent event) {
                // TODO = for being more selective about where something can be dropped, consider applying additional if-statement logic
                /*
                 *you might want to design the application so dropping at an invalid location drops at the most recent valid location hovered over,
                 * or simply allow the card/item to return to its slot (the latter is easier, as you won't have to store the last valid drop location!)
                 */
<span class="nc" id="L659">                boolean isValid = true;  // it means whether the position is valid</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">                if (currentlyDraggedType == draggableType){</span>
                    // problem = event is drop completed is false when should be true...
                    // https://bugs.openjdk.java.net/browse/JDK-8117019
                    // putting drop completed at start not making complete on VLAB...

                    //Data dropped
                    //If there is an image on the dragboard, read it and use it
<span class="nc" id="L667">                    Dragboard db = event.getDragboard();</span>
<span class="nc" id="L668">                    Node node = event.getPickResult().getIntersectedNode();</span>
<span class="nc bnc" id="L669" title="All 4 branches missed.">                    if(node != targetGridPane &amp;&amp; db.hasImage()){</span>

<span class="nc" id="L671">                        Integer cIndex = GridPane.getColumnIndex(node);</span>
<span class="nc" id="L672">                        Integer rIndex = GridPane.getRowIndex(node);</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                        int x = cIndex == null ? 0 : cIndex;</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                        int y = rIndex == null ? 0 : rIndex;</span>
                        //Places at 0,0 - will need to take coordinates once that is implemented
<span class="nc" id="L676">                        ImageView image = new ImageView(db.getImage());</span>

<span class="nc" id="L678">                        int nodeX = GridPane.getColumnIndex(currentlyDraggedImage);</span>
<span class="nc" id="L679">                        int nodeY = GridPane.getRowIndex(currentlyDraggedImage);</span>

<span class="nc bnc" id="L681" title="All 3 branches missed.">                        switch (draggableType){</span>
                            case CARD:
                                // check whether the position is valid
<span class="nc bnc" id="L684" title="All 2 branches missed.">                                if(currentlyDraggedImage.getImage() == towerCardImage ||</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">                                currentlyDraggedImage.getImage() == zombiePitCardImage ||</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">                                currentlyDraggedImage.getImage() == vampireCastleCardImage ||</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                                currentlyDraggedImage.getImage() == campfireCardImage){</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">                                    if(!world.checkAdjacentPath(x, y)){</span>
<span class="nc" id="L689">                                        isValid = false;</span>
                                    }
                                }
                                else{
<span class="nc bnc" id="L693" title="All 2 branches missed.">                                    if(!world.checkInPath(x, y)){</span>
<span class="nc" id="L694">                                        isValid = false;</span>
                                    }
                                }
                                
<span class="nc bnc" id="L698" title="All 2 branches missed.">                                if(isValid){</span>
<span class="nc" id="L699">                                    removeDraggableDragEventHandlers(draggableType, targetGridPane);</span>
                                    // DONE = spawn a building here of different types
<span class="nc" id="L701">                                    Building newBuilding = convertCardToBuildingByCoordinates(nodeX, nodeY, x, y);</span>
<span class="nc" id="L702">                                    onLoad(newBuilding);</span>
<span class="nc" id="L703">                                }else{</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                                    for (Node mNode: targetGridPane.getChildren()){</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">                                        if(mNode.getOpacity() &lt; 1){</span>
<span class="nc" id="L706">                                            mNode.setOpacity(1);</span>
                                        }
<span class="nc" id="L708">                                    }</span>
                                }
<span class="nc" id="L710">                                break;</span>
                            case ITEM:
<span class="nc" id="L712">                                removeDraggableDragEventHandlers(draggableType, targetGridPane);</span>
                                // spawn an item in the new location. 
<span class="nc" id="L714">                                Item currentItem = world.GetEquippedFromUnequippedByCoordinates(nodeX, nodeY, x, y);</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">                                if (currentItem != null) {</span>
<span class="nc" id="L716">                                    targetGridPane.add(image, x, y, 1, 1);</span>
<span class="nc" id="L717">                                    world.setCharacterEquipment(world.getCharacter(), currentItem);</span>
                                } else {
<span class="nc bnc" id="L719" title="All 2 branches missed.">                                    for (Node mNode: targetGridPane.getChildren()){</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">                                        if(mNode.getOpacity() &lt; 1){</span>
<span class="nc" id="L721">                                            mNode.setOpacity(1);</span>
                                        }
<span class="nc" id="L723">                                    }</span>
<span class="nc" id="L724">                                    sourceGridPane.add(image, nodeX, nodeY);</span>
<span class="nc" id="L725">                                    addDragEventHandlers(image, DRAGGABLE_TYPE.ITEM, unequippedInventory, equippedItems);</span>
                                }
<span class="nc" id="L727">                                break;</span>
                            default:
                                break;
                        }
                        
<span class="nc bnc" id="L732" title="All 2 branches missed.">                        if(isValid){</span>
<span class="nc" id="L733">                            draggedEntity.setVisible(false);</span>
<span class="nc" id="L734">                            draggedEntity.setMouseTransparent(false);</span>
                            // remove drag event handlers before setting currently dragged image to null
<span class="nc" id="L736">                            currentlyDraggedImage = null;</span>
<span class="nc" id="L737">                            currentlyDraggedType = null;</span>
<span class="nc" id="L738">                            printThreadingNotes(&quot;DRAG DROPPED ON GRIDPANE HANDLED&quot;);</span>
                        }
                    }
                }
<span class="nc bnc" id="L742" title="All 2 branches missed.">                if(isValid){</span>
<span class="nc" id="L743">                    event.setDropCompleted(true);</span>
                    // consuming prevents the propagation of the event to the anchorPaneRoot (as a sub-node of anchorPaneRoot, GridPane is prioritized)
                    // https://openjfx.io/javadoc/11/javafx.base/javafx/event/Event.html#consume()
                    // to understand this in full detail, ask your tutor or read https://docs.oracle.com/javase/8/javafx/events-tutorial/processing.htm
<span class="nc" id="L747">                    event.consume();</span>
                }
<span class="nc" id="L749">            }</span>
        });

        // this doesn't fire when we drag over GridPane because in the event handler for dragging over GridPanes, we consume the event
<span class="nc" id="L753">        anchorPaneRootSetOnDragOver.put(draggableType, new EventHandler&lt;DragEvent&gt;(){</span>
            // https://github.com/joelgraff/java_fx_node_link_demo/blob/master/Draggable_Node/DraggableNodeDemo/src/application/RootLayout.java#L110
            @Override
            public void handle(DragEvent event) {
<span class="nc bnc" id="L757" title="All 2 branches missed.">                if (currentlyDraggedType == draggableType){</span>
<span class="nc bnc" id="L758" title="All 4 branches missed.">                    if(event.getGestureSource() != anchorPaneRoot &amp;&amp; event.getDragboard().hasImage()){</span>
<span class="nc" id="L759">                        event.acceptTransferModes(TransferMode.MOVE);</span>
                    }
                }
<span class="nc bnc" id="L762" title="All 2 branches missed.">                if (currentlyDraggedType != null){</span>
<span class="nc" id="L763">                    draggedEntity.relocateToPoint(new Point2D(event.getSceneX(), event.getSceneY()));</span>
                }
<span class="nc" id="L765">                event.consume();</span>
<span class="nc" id="L766">            }</span>
        });

        // this doesn't fire when we drop over GridPane because in the event handler for dropping over GridPanes, we consume the event
<span class="nc" id="L770">        anchorPaneRootSetOnDragDropped.put(draggableType, new EventHandler&lt;DragEvent&gt;() {</span>
            public void handle(DragEvent event) {
<span class="nc bnc" id="L772" title="All 2 branches missed.">                if (currentlyDraggedType == draggableType){</span>
                    //Data dropped
                    //If there is an image on the dragboard, read it and use it
<span class="nc" id="L775">                    Dragboard db = event.getDragboard();</span>
<span class="nc" id="L776">                    Node node = event.getPickResult().getIntersectedNode();</span>
<span class="nc bnc" id="L777" title="All 4 branches missed.">                    if(node != anchorPaneRoot &amp;&amp; db.hasImage()){</span>
                        //Places at 0,0 - will need to take coordinates once that is implemented
<span class="nc" id="L779">                        currentlyDraggedImage.setVisible(true);</span>
<span class="nc" id="L780">                        draggedEntity.setVisible(false);</span>
<span class="nc" id="L781">                        draggedEntity.setMouseTransparent(false);</span>
                        // remove drag event handlers before setting currently dragged image to null
<span class="nc" id="L783">                        removeDraggableDragEventHandlers(draggableType, targetGridPane);</span>
                        
<span class="nc" id="L785">                        currentlyDraggedImage = null;</span>
<span class="nc" id="L786">                        currentlyDraggedType = null;</span>
                    }
                }
                //let the source know whether the image was successfully transferred and used
<span class="nc" id="L790">                event.setDropCompleted(true);</span>
<span class="nc" id="L791">                event.consume();</span>
<span class="nc" id="L792">            }</span>
        });
<span class="nc" id="L794">    }</span>

    /**
     * remove the card from the world, and spawn and return a building instead where the card was dropped
     * @param cardNodeX the x coordinate of the card which was dragged, from 0 to width-1
     * @param cardNodeY the y coordinate of the card which was dragged (in starter code this is 0 as only 1 row of cards)
     * @param buildingNodeX the x coordinate of the drop location for the card, where the building will spawn, from 0 to width-1
     * @param buildingNodeY the y coordinate of the drop location for the card, where the building will spawn, from 0 to height-1
     * @return building entity returned from the world
     */
    private Building convertCardToBuildingByCoordinates(int cardNodeX, int cardNodeY, int buildingNodeX, int buildingNodeY) {
<span class="nc" id="L805">        return world.convertCardToBuildingByCoordinates(cardNodeX, cardNodeY, buildingNodeX, buildingNodeY);</span>
    }

    /**
     * remove an item from the unequipped inventory by its x and y coordinates in the unequipped inventory gridpane
     * @param nodeX x coordinate from 0 to unequippedInventoryWidth-1
     * @param nodeY y coordinate from 0 to unequippedInventoryHeight-1
     */
    //private void removeItemByCoordinates(int nodeX, int nodeY) {
    //   world.removeUnequippedInventoryItemByCoordinates(nodeX, nodeY);
    //}

    /**
     * add drag event handlers to an ImageView
     * @param view the view to attach drag event handlers to
     * @param draggableType the type of item being dragged - card or item
     * @param sourceGridPane the relevant gridpane from which the entity would be dragged
     * @param targetGridPane the relevant gridpane to which the entity would be dragged to
     */
    private void addDragEventHandlers(ImageView view, DRAGGABLE_TYPE draggableType, GridPane sourceGridPane, GridPane targetGridPane){
<span class="nc" id="L825">        view.setOnDragDetected(new EventHandler&lt;MouseEvent&gt;() {</span>
            public void handle(MouseEvent event) {
<span class="nc" id="L827">                currentlyDraggedImage = view; // set image currently being dragged, so squares setOnDragEntered can detect it...</span>
<span class="nc" id="L828">                currentlyDraggedType = draggableType;</span>
                //Drag was detected, start drap-and-drop gesture
                //Allow any transfer node
<span class="nc" id="L831">                Dragboard db = view.startDragAndDrop(TransferMode.MOVE);</span>
    
                //Put ImageView on dragboard
<span class="nc" id="L834">                ClipboardContent cbContent = new ClipboardContent();</span>
<span class="nc" id="L835">                cbContent.putImage(view.getImage());</span>
<span class="nc" id="L836">                db.setContent(cbContent);</span>
<span class="nc" id="L837">                view.setVisible(false);</span>

<span class="nc" id="L839">                buildNonEntityDragHandlers(draggableType, sourceGridPane, targetGridPane);</span>

<span class="nc" id="L841">                draggedEntity.relocateToPoint(new Point2D(event.getSceneX(), event.getSceneY()));</span>
<span class="nc bnc" id="L842" title="All 3 branches missed.">                switch (draggableType){</span>
                    case CARD:
<span class="nc" id="L844">                        draggedEntity.setImage(view.getImage());</span>
<span class="nc" id="L845">                        break;</span>
                    case ITEM:
<span class="nc" id="L847">                        draggedEntity.setImage(view.getImage());</span>
<span class="nc" id="L848">                        break;</span>
                    default:
                        break;
                }
                
<span class="nc" id="L853">                draggedEntity.setVisible(true);</span>
<span class="nc" id="L854">                draggedEntity.setMouseTransparent(true);</span>
<span class="nc" id="L855">                draggedEntity.toFront();</span>

                // IMPORTANT!!!
                // to be able to remove event handlers, need to use addEventHandler
                // https://stackoverflow.com/a/67283792
<span class="nc" id="L860">                targetGridPane.addEventHandler(DragEvent.DRAG_DROPPED, gridPaneSetOnDragDropped.get(draggableType));</span>
<span class="nc" id="L861">                anchorPaneRoot.addEventHandler(DragEvent.DRAG_OVER, anchorPaneRootSetOnDragOver.get(draggableType));</span>
<span class="nc" id="L862">                anchorPaneRoot.addEventHandler(DragEvent.DRAG_DROPPED, anchorPaneRootSetOnDragDropped.get(draggableType));</span>

<span class="nc bnc" id="L864" title="All 2 branches missed.">                for (Node n: targetGridPane.getChildren()){</span>
                    // events for entering and exiting are attached to squares children because that impacts opacity change
                    // these do not affect visibility of original image...
                    // https://stackoverflow.com/questions/41088095/javafx-drag-and-drop-to-gridpane
<span class="nc" id="L868">                    gridPaneNodeSetOnDragEntered.put(draggableType, new EventHandler&lt;DragEvent&gt;() {</span>
                        // TODO = be more selective about whether highlighting changes - if it cannot be dropped in the location, the location shouldn't be highlighted!
                        public void handle(DragEvent event) {
<span class="nc bnc" id="L871" title="All 2 branches missed.">                            if (currentlyDraggedType == draggableType){</span>
                            //The drag-and-drop gesture entered the target
                            //show the user that it is an actual gesture target
<span class="nc bnc" id="L874" title="All 4 branches missed.">                                if(event.getGestureSource() != n &amp;&amp; event.getDragboard().hasImage()){</span>
<span class="nc" id="L875">                                    n.setOpacity(0.7);</span>
                                }
                            }
<span class="nc" id="L878">                            event.consume();</span>
<span class="nc" id="L879">                        }</span>
                    });
<span class="nc" id="L881">                    gridPaneNodeSetOnDragExited.put(draggableType, new EventHandler&lt;DragEvent&gt;() {</span>
                        // TODO = since being more selective about whether highlighting changes, you could program the game so if the new highlight location is invalid the highlighting doesn't change, or leave this as-is
                        public void handle(DragEvent event) {
<span class="nc bnc" id="L884" title="All 2 branches missed.">                            if (currentlyDraggedType == draggableType){</span>
<span class="nc" id="L885">                                n.setOpacity(1);</span>
                            }
                
<span class="nc" id="L888">                            event.consume();</span>
<span class="nc" id="L889">                        }</span>
                    });
<span class="nc" id="L891">                    n.addEventHandler(DragEvent.DRAG_ENTERED, gridPaneNodeSetOnDragEntered.get(draggableType));</span>
<span class="nc" id="L892">                    n.addEventHandler(DragEvent.DRAG_EXITED, gridPaneNodeSetOnDragExited.get(draggableType));</span>
<span class="nc" id="L893">                }</span>
<span class="nc" id="L894">                event.consume();</span>
<span class="nc" id="L895">            }</span>
            
        });
<span class="nc" id="L898">    }</span>

    /**
     * remove drag event handlers so that we don't process redundant events
     * this is particularly important for slower machines such as over VLAB.
     * @param draggableType either cards, or items in unequipped inventory
     * @param targetGridPane the gridpane to remove the drag event handlers from
     */
    private void removeDraggableDragEventHandlers(DRAGGABLE_TYPE draggableType, GridPane targetGridPane){
        // remove event handlers from nodes in children squares, from anchorPaneRoot, and squares
<span class="nc" id="L908">        targetGridPane.removeEventHandler(DragEvent.DRAG_DROPPED, gridPaneSetOnDragDropped.get(draggableType));</span>

<span class="nc" id="L910">        anchorPaneRoot.removeEventHandler(DragEvent.DRAG_OVER, anchorPaneRootSetOnDragOver.get(draggableType));</span>
<span class="nc" id="L911">        anchorPaneRoot.removeEventHandler(DragEvent.DRAG_DROPPED, anchorPaneRootSetOnDragDropped.get(draggableType));</span>

<span class="nc bnc" id="L913" title="All 2 branches missed.">        for (Node n: targetGridPane.getChildren()){</span>
<span class="nc" id="L914">            n.removeEventHandler(DragEvent.DRAG_ENTERED, gridPaneNodeSetOnDragEntered.get(draggableType));</span>
<span class="nc" id="L915">            n.removeEventHandler(DragEvent.DRAG_EXITED, gridPaneNodeSetOnDragExited.get(draggableType));</span>
<span class="nc" id="L916">        }</span>
<span class="nc" id="L917">    }</span>

    /**
     * handle the pressing of keyboard keys.
     * Specifically, we should pause when pressing SPACE
     * @param event some keyboard key press
     */
    @FXML
    public void handleKeyPress(KeyEvent event) {
        // TODO = handle additional key presses, e.g. for consuming a health potion
<span class="nc bnc" id="L927" title="All 2 branches missed.">        switch (event.getCode()) {</span>
        case SPACE:
<span class="nc bnc" id="L929" title="All 2 branches missed.">            if (isPaused){</span>
<span class="nc" id="L930">                startTimer();</span>
            }
            else{
<span class="nc" id="L933">                pause();</span>
            }
<span class="nc" id="L935">            break;</span>
        default:
            break;
        }
<span class="nc" id="L939">    }</span>

    public void setMainMenuSwitcher(MenuSwitcher mainMenuSwitcher){
        // TODO = possibly set other menu switchers
<span class="nc" id="L943">        this.mainMenuSwitcher = mainMenuSwitcher;</span>
<span class="nc" id="L944">    }</span>

    /**
     * this method is triggered when click button to go to main menu in FXML
     * @throws IOException
     */
    @FXML
    private void switchToMainMenu() throws IOException {
        // TODO = possibly set other menu switchers
<span class="nc" id="L953">        pause();</span>
<span class="nc" id="L954">        heroCastleBuilding.closeStore();</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (world.goalCheck()) {</span>
            // game end
<span class="nc" id="L957">            System.out.print(&quot;you have meet the conditio!&quot;);</span>
        } else {
<span class="nc" id="L959">            System.out.print(&quot;you have not meet the condition!&quot;);</span>

        }
<span class="nc" id="L962">        mainMenuSwitcher.switchMenu();</span>
<span class="nc" id="L963">    }</span>

    /**
     * Set a node in a GridPane to have its position track the position of an
     * entity in the world.
     *
     * By connecting the model with the view in this way, the model requires no
     * knowledge of the view and changes to the position of entities in the
     * model will automatically be reflected in the view.
     * 
     * note that this is put in the controller rather than the loader because we need to track positions of spawned entities such as enemy
     * or items which might need to be removed should be tracked here
     * 
     * NOTE teardown functions setup here also remove nodes from their GridPane. So it is vital this is handled in this Controller class
     * @param entity
     * @param node
     */
    private void trackPosition(Entity entity, Node node) {
        // TODO = tweak this slightly to remove items from the equipped inventory?
<span class="nc" id="L982">        GridPane.setColumnIndex(node, entity.getX());</span>
<span class="nc" id="L983">        GridPane.setRowIndex(node, entity.getY());</span>

<span class="nc" id="L985">        ChangeListener&lt;Number&gt; xListener = new ChangeListener&lt;Number&gt;() {</span>
            @Override
            public void changed(ObservableValue&lt;? extends Number&gt; observable,
                    Number oldValue, Number newValue) {
<span class="nc" id="L989">                GridPane.setColumnIndex(node, newValue.intValue());</span>
<span class="nc" id="L990">            }</span>
        };
<span class="nc" id="L992">        ChangeListener&lt;Number&gt; yListener = new ChangeListener&lt;Number&gt;() {</span>
            @Override
            public void changed(ObservableValue&lt;? extends Number&gt; observable,
                    Number oldValue, Number newValue) {
<span class="nc" id="L996">                GridPane.setRowIndex(node, newValue.intValue());</span>
<span class="nc" id="L997">            }</span>
        };

        // if need to remove items from the equipped inventory, add code to remove from equipped inventory gridpane in the .onDetach part
<span class="nc" id="L1001">        ListenerHandle handleX = ListenerHandles.createFor(entity.x(), node)</span>
<span class="nc" id="L1002">                                               .onAttach((o, l) -&gt; o.addListener(xListener))</span>
<span class="nc" id="L1003">                                               .onDetach((o, l) -&gt; {</span>
<span class="nc" id="L1004">                                                    o.removeListener(xListener);</span>
<span class="nc" id="L1005">                                                    entityImages.remove(node);</span>
<span class="nc" id="L1006">                                                    squares.getChildren().remove(node);</span>
<span class="nc" id="L1007">                                                    cards.getChildren().remove(node);</span>
<span class="nc" id="L1008">                                                    equippedItems.getChildren().remove(node);</span>
<span class="nc" id="L1009">                                                    unequippedInventory.getChildren().remove(node);</span>
<span class="nc" id="L1010">                                                })</span>
<span class="nc" id="L1011">                                               .buildAttached();</span>
<span class="nc" id="L1012">        ListenerHandle handleY = ListenerHandles.createFor(entity.y(), node)</span>
<span class="nc" id="L1013">                                               .onAttach((o, l) -&gt; o.addListener(yListener))</span>
<span class="nc" id="L1014">                                               .onDetach((o, l) -&gt; {</span>
                                                   o.removeListener(yListener);
                                                   entityImages.remove(node);
                                                   squares.getChildren().remove(node);
                                                   cards.getChildren().remove(node);
                                                   equippedItems.getChildren().remove(node);
                                                   unequippedInventory.getChildren().remove(node);
                                                })
<span class="nc" id="L1022">                                               .buildAttached();</span>
<span class="nc" id="L1023">        handleX.attach();</span>
<span class="nc" id="L1024">        handleY.attach();</span>

        // this means that if we change boolean property in an entity tracked from here, position will stop being tracked
        // this wont work on character/path entities loaded from loader classes
<span class="nc" id="L1028">        entity.shouldExist().addListener(new ChangeListener&lt;Boolean&gt;(){</span>
            @Override
            public void changed(ObservableValue&lt;? extends Boolean&gt; obervable, Boolean oldValue, Boolean newValue) {
<span class="nc" id="L1031">                handleX.detach();</span>
<span class="nc" id="L1032">                handleY.detach();</span>
<span class="nc" id="L1033">            }</span>
        });
<span class="nc" id="L1035">    }</span>
    
    /**
     * getter of timeline
     * @return timeline
     */
    public Timeline getTimeLine(){
<span class="nc" id="L1042">        return timeline;</span>
    }

    /**
     * getter of loopmaniaword
     * @return loopmaniaword
     */
    public LoopManiaWorld getLoopManiaWorld(){
<span class="nc" id="L1050">        return world;</span>
    }
    
    /**
     * eventhandler used to respond to view the description of the card
     */
    private  class CardMouseHoverHandler implements EventHandler&lt;MouseEvent&gt;{
        private String name;
        private String description;
<span class="nc" id="L1059">        public CardMouseHoverHandler(String name, String description){</span>
<span class="nc" id="L1060">            this.name = name;</span>
<span class="nc" id="L1061">            this.description = description;</span>
<span class="nc" id="L1062">        }</span>
        @Override
        public void handle(MouseEvent e) {
<span class="nc" id="L1065">            cardDescription.show(name, description);</span>
<span class="nc" id="L1066">        } </span>
    }

    /**
     * eventhandler used to respond to close the description of the card
     */
<span class="nc" id="L1072">    private  class CardMouseLeaveHandler implements EventHandler&lt;MouseEvent&gt;{</span>
        @Override
        public void handle(MouseEvent e) {
<span class="nc" id="L1075">            cardDescription.close();</span>
<span class="nc" id="L1076">        }</span>
        
    }


    /**
     * set primary stage
     * @param primaryStage
     */
    public void setPrimaryStage(Stage stage){
<span class="nc" id="L1086">        primaryStage = stage;</span>
<span class="nc" id="L1087">    }</span>

    /**
     * get primary stage
     * @return primary stage
     */
    public Stage getPrimayStage(){
<span class="nc" id="L1094">        return primaryStage;</span>
    }


    public boolean isSurvivalMode() {
<span class="nc" id="L1099">        return isSurvivalMode;</span>
    }

    public AnchorPane getStats() {
<span class="nc" id="L1103">        return stats;</span>
    }

    public void closeStore(){
<span class="nc" id="L1107">        heroCastleBuilding.closeStore();</span>
<span class="nc" id="L1108">    }</span>

    public void setMainMenuController(MainMenuController mainMenuController){
<span class="nc" id="L1111">        this.mainMenuController = mainMenuController;</span>
<span class="nc" id="L1112">    }</span>

    public Mode getModeReq(){
<span class="nc" id="L1115">        return mainMenuController.getMode_req();</span>
    }

    /**
     * we added this method to help with debugging so you could check your code is running on the application thread.
     * By running everything on the application thread, you will not need to worry about implementing locks, which is outside the scope of the course.
     * Always writing code running on the application thread will make the project easier, as long as you are not running time-consuming tasks.
     * We recommend only running code on the application thread, by using Timelines when you want to run multiple processes at once.
     * EventHandlers will run on the application thread.
     */
    private void printThreadingNotes(String currentMethodLabel){
        // System.out.println(&quot;\n###########################################&quot;);
        // System.out.println(&quot;current method = &quot;+currentMethodLabel);
        // System.out.println(&quot;In application thread? = &quot;+Platform.isFxApplicationThread());
        // System.out.println(&quot;Current system time = &quot;+java.time.LocalDateTime.now().toString().replace('T', ' '));
<span class="nc" id="L1130">    }</span>

    /**
     * set the one ring image to balck tiny when used it 
     */
    public void setUsedTheOneRingImage() {
<span class="nc bnc" id="L1136" title="All 2 branches missed.">        if (world.getCharacter().getTheOneRing() == null) {</span>
<span class="nc" id="L1137">            ImageView image = new ImageView(emptyTheOneRingImage);</span>
<span class="nc" id="L1138">            equippedItems.add(image, 3, 0, 1, 1);</span>
<span class="nc" id="L1139">            world.setUsedTheOneRing(false);</span>
        }
<span class="nc" id="L1141">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>